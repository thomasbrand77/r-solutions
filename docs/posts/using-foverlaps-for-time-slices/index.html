<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Thomas Brand">
<meta name="dcterms.date" content="2025-07-02">

<title>using foverlaps for time-slices – r-solutions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6964cec736b65266f614e8c6f7b9f238.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">r-solutions</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/thomasbrand77"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/thomas-brand-0b5324186/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">using foverlaps for time-slices</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">news</div>
                <div class="quarto-category">code</div>
                <div class="quarto-category">data.table</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Thomas Brand </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 2, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="abstract" class="level1">
<h1>Abstract</h1>
<p>In this blog I will show you how to split time-slices in client-data so that each row will be reproduced as many times as there are overlaps with a given set of relevant intervals by also preserving the other relevant information of the rows. We will do this by using the foverlaps-function of the data.table package together with some tweaks. We will cover some special cases, too.</p>
<p><img src="example_table.png" class="img-fluid"></p>
</section>
<section id="problem-definition" class="level1">
<h1>Problem definition</h1>
<p>In customer/client databases it is often the case that each row in a table has a validity from one date <code>startDate</code> to another date <code>endDate</code>. You have to interpret this row so that the information that are contained in other columns of this row are valid just from <code>startDate</code> to <code>endDate</code>.</p>
<p>These rows are referred to as time-slices.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>As an indication of time-slice without end (i.e.&nbsp;the end isn’t known by now) you normally use a date far in the future, e.g.&nbsp;9999-12-31.</p>
<p>It is as well useful for joining operations and calulations, that the <code>endDate</code> corresponds to the first Date where the slice isn’t valid any more. In this way you can stitch together the slices of a person by the corresponding <code>startDate</code> to an <code>endDate</code>.</p>
</div>
</div>
<p>In mathematical terms we have an interval, that is closed at the left and open at the right: <span class="math inline">\([a, b)\)</span>.</p>
<p>Let’s look at some example-data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"./client_data.Rdata"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 13%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">client</th>
<th style="text-align: left;">plan</th>
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: right;">basicPrice</th>
<th style="text-align: right;">discount</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">34.56</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">34.56</td>
</tr>
<tr class="even">
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This is of course a simplified example.</p>
<p>Our task will be to calculate the cumulative payments per plan for each month from September 2024 to March 2025. For this one possible solution would be to generate one line per costumer for each plan and each month. With this solution it will be easier to calculate the amount to pay for time slices, that don’t start or end at the beginning of a month.</p>
</section>
<section id="solution" class="level1">
<h1>Solution</h1>
<section id="explanation-for-date-intervals" class="level2">
<h2 class="anchored" data-anchor-id="explanation-for-date-intervals">Explanation for date intervals</h2>
<p>With this date conventions</p>
<ol type="1">
<li><p>the <code>startDate</code> is the first date that the row is valid and</p></li>
<li><p>the <code>endDate</code> is the first date that the row isn’t valid any more,</p></li>
</ol>
<p>you can easily calculate the months with the <a href="https://lubridate.tidyverse.org">lubridate</a>-package and the <a href="https://lubridate.tidyverse.org/reference/interval.html">interval</a>-function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the months</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">interval</span>(<span class="at">start =</span> <span class="fu">as.Date</span>(<span class="st">"2025-02-01"</span>), <span class="at">end =</span> <span class="fu">as.Date</span>(<span class="st">"2025-04-01"</span>)) <span class="sc">%/%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
</div>
<p>If we had the convention that the endDate would be the last date where the row is still valid the calulations wouldn’t add up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the months</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">interval</span>(<span class="at">start =</span> <span class="fu">as.Date</span>(<span class="st">"2025-02-01"</span>), <span class="at">end =</span> <span class="fu">as.Date</span>(<span class="st">"2025-03-31"</span>)) <span class="sc">%/%</span> <span class="fu">months</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
</section>
<section id="introduction-of-foverlaps" class="level2">
<h2 class="anchored" data-anchor-id="introduction-of-foverlaps">Introduction of foverlaps</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For a detailed explanation of what you can do with the data.table-package please see</p>
<p>Barrett T, Dowle M, Srinivasan A, Gorecki J, Chirico M, Hocking T, Schwendinger B, Krylov I (2025).&nbsp;<em>data.table: Extension of ‘data.frame’</em>. R package version 1.17.99,&nbsp;<a href="https://r-datatable.com/">https://r-datatable.com</a>.</p>
</div>
</div>
<p>First, we will generate a data.table with two columns for the begin and the end of an interval. Each row will cover exactly one month. This can be done with the following code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>intervals <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">startDate =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-09-01"</span>), <span class="at">to =</span> <span class="fu">as.Date</span>(<span class="st">"2025-04-01"</span>), <span class="at">by =</span> <span class="st">"month"</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>intervals[,endDate <span class="sc">:</span><span class="er">=</span> <span class="fu">shift</span>(startDate, <span class="at">type =</span> <span class="st">"lead"</span>)]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>intervals <span class="ot">=</span> <span class="fu">na.omit</span>(intervals)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"startDate"</span>,<span class="st">"endDate"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(intervals, cols)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>intervals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Next we will start a first try to see what foverlaps will produce. We expect</p>
<ul>
<li><p>7 rows for customer A Plan T1 (i.e.&nbsp;for erery row in intervals)<br>
</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>startDate</th>
<th>endDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-09-01</td>
<td>2024-10-01</td>
</tr>
<tr class="even">
<td>2024-10-01</td>
<td>2024-11-01</td>
</tr>
<tr class="odd">
<td>2024-11-01</td>
<td>2024-12-01</td>
</tr>
<tr class="even">
<td>2024-12-01</td>
<td>2025-01-01</td>
</tr>
<tr class="odd">
<td>2025-01-01</td>
<td>2025-02-01</td>
</tr>
<tr class="even">
<td>2025-02-01</td>
<td>2025-03-01</td>
</tr>
<tr class="odd">
<td>2025-03-01</td>
<td>2025-04-01</td>
</tr>
</tbody>
</table></li>
<li><p>4 rows für customer B Plan T1<br>
</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>startDate</th>
<th>endDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-11-06</td>
<td>2024-12-01</td>
</tr>
<tr class="even">
<td>2024-12-01</td>
<td>2025-01-01</td>
</tr>
<tr class="odd">
<td>2025-01-01</td>
<td>2025-02-01</td>
</tr>
<tr class="even">
<td>2025-02-01</td>
<td>2025-03-01</td>
</tr>
</tbody>
</table></li>
<li><p>1 row für customer B Plan T2<br>
</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>startDate</th>
<th>endDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2025-03-01</td>
<td>2025-04-01</td>
</tr>
</tbody>
</table></li>
<li><p>4 rows for customer C Plan T2<br>
</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>startDate</th>
<th>endDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-09-01</td>
<td>2024-10-01</td>
</tr>
<tr class="even">
<td>2024-10-01</td>
<td>2024-11-01</td>
</tr>
<tr class="odd">
<td>2024-11-01</td>
<td>2024-12-01</td>
</tr>
<tr class="even">
<td>2024-12-01</td>
<td>2025-01-01</td>
</tr>
</tbody>
</table></li>
</ul>
<p>We get instead</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">foverlaps</span>(dt, intervals, <span class="at">by.x =</span> cols, <span class="at">by.y =</span> cols)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">client</th>
<th style="text-align: left;">plan</th>
<th style="text-align: left;">i.startDate</th>
<th style="text-align: left;">i.endDate</th>
<th style="text-align: right;">basicPrice</th>
<th style="text-align: right;">discount</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">34.56</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">34.56</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">34.56</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">34.56</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We can see, that every row of the original table was multiplied into as many rows as had overlaps with the rows of the intervals-table.</p>
<p>In the result we have</p>
<ul>
<li><p><code>startDate</code> and <code>endDate</code> as the corresponding values of the intervals-table and</p></li>
<li><p><code>i.startDate</code> and i.<code>endDate</code> as the original values of the table</p></li>
<li><p>we did get</p>
<ul>
<li><p>the 7 rows for customer A Plan T1</p></li>
<li><p>5 rows instead of 4 for customer B Plan T1 an the wrong start date for the fisrt row</p></li>
<li><p>2 rows instead of 1 for customer B Plan T2</p></li>
<li><p>5 rowa instead of 4 for customer C Plan T2</p></li>
</ul></li>
</ul>
<p>Let’s look closer at the rows with the numbers 12, 13, 19</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>result[<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">19</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">client</th>
<th style="text-align: left;">plan</th>
<th style="text-align: left;">i.startDate</th>
<th style="text-align: left;">i.endDate</th>
<th style="text-align: right;">basicPrice</th>
<th style="text-align: right;">discount</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">34.56</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">34.56</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Comparing <code>startDate</code> and <code>endDate</code> with <code>i.startDate</code> and <code>i.endDate</code> we can see the foverlaps generated a row for the month, but that the current intervals ended the month before or didn’t even have started.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The reason for this is, that we have defined our intervals as open on the right.</p>
<p>By default the foverlaps-function used an overlap-mode “any” which will produce an overlap of two intervals <span class="math inline">\([a,b]\)</span> and <span class="math inline">\([c,d]\)</span> if <span class="math inline">\(c\le b \wedge d\ge a\)</span> . So all intervals are treated as closed intervals.</p>
<p>Unfortunately the other available types of overlaps in foverlaps don’t suit our requirements:</p>
<ul>
<li><p>“within” - the interval has to lie within the other to overlap</p></li>
<li><p>“start” - the start-dates have to be equal to overlap</p></li>
<li><p>“end” - the end-dates have to be equal to overlap</p></li>
<li><p>“equal” - the intervals have to be identical to overlap</p></li>
</ul>
<p>Maybe this will change if the minoverlap-attribute is implemented.</p>
</div>
</div>
<p>On the other hand we have row 8, which is also wrong</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>result[<span class="fu">c</span>(<span class="dv">8</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">client</th>
<th style="text-align: left;">plan</th>
<th style="text-align: left;">i.startDate</th>
<th style="text-align: left;">i.endDate</th>
<th style="text-align: right;">basicPrice</th>
<th style="text-align: right;">discount</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Comparing the original values with the new ones we can see, that the row isn’t correct, as <span class="math inline">\([2024-11-01,2024-12-01)\)</span> isn’t completely contained in the original interval <span class="math inline">\([2024-11-06,2025-03-01)\)</span>.</p>
</section>
<section id="transforming-the-intervals---enddate" class="level2">
<h2 class="anchored" data-anchor-id="transforming-the-intervals---enddate">Transforming the intervals - endDate</h2>
<p>Therefore we have to change our intervals from open on the right side to closed on the right side. We can do this by subtracting one day from the end. We will create a new column <code>endDatem1</code> in our <code>dt</code>- and our <code>intervals</code>-tables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dt[,endDatem1 <span class="sc">:</span><span class="er">=</span> endDate <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>intervals[,endDatem1 <span class="sc">:</span><span class="er">=</span> endDate <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>colsm1 <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"startDate"</span>,<span class="st">"endDatem1"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(intervals, colsm1)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>intervals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">endDatem1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-09-30</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-10-31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2024-11-30</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2024-12-31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-01-31</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-02-28</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">2025-03-31</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Lets try foverlaps again with <code>startDate</code> and <code>endDatem1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>result_m1 <span class="ot">=</span> <span class="fu">foverlaps</span>(dt, intervals, <span class="at">by.x =</span> colsm1, <span class="at">by.y =</span> colsm1)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>col_selected <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"startDate"</span>,<span class="st">"endDate"</span>,<span class="st">"client"</span>,<span class="st">"plan"</span>,<span class="st">"i.startDate"</span>,<span class="st">"i.endDate"</span>,<span class="st">"basicPrice"</span>,<span class="st">"discount"</span>,<span class="st">"toPayPerMonth"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>result_m1[,..col_selected]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">client</th>
<th style="text-align: left;">plan</th>
<th style="text-align: left;">i.startDate</th>
<th style="text-align: left;">i.endDate</th>
<th style="text-align: right;">basicPrice</th>
<th style="text-align: right;">discount</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">34.56</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">34.56</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>For clarity we have omitted the m1-suffix columns in the output. As we can see the results are correct now. The incorrect rows 12, 13 and 19 have vanished.</p>
</section>
<section id="transforming-the-intervals---startdate" class="level2">
<h2 class="anchored" data-anchor-id="transforming-the-intervals---startdate">Transforming the intervals - startDate</h2>
<p>To correct the incorrect row number 8 we have to replace the startDate in every row where it is smaller than i.startDate with the value in i.startDate</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>result_m1[startDate <span class="sc">&lt;</span> i.startDate, startDate <span class="sc">:</span><span class="er">=</span> i.startDate]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>result_m1[,..col_selected]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">client</th>
<th style="text-align: left;">plan</th>
<th style="text-align: left;">i.startDate</th>
<th style="text-align: left;">i.endDate</th>
<th style="text-align: right;">basicPrice</th>
<th style="text-align: right;">discount</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">A</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-07-06</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">12.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">12.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">2024-11-06</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: right;">23.45</td>
<td style="text-align: right;">-1.45</td>
<td style="text-align: right;">22.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">B</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: right;">34.56</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">34.56</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-09-01</td>
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-10-01</td>
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2024-11-01</td>
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">2024-12-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">C</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">2024-08-01</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: right;">14.79</td>
<td style="text-align: right;">-3.79</td>
<td style="text-align: right;">11.00</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We can now use <code>startDate</code> and <code>endDate</code> for further calculations.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important, that we tweaked the result in exact this order</p>
<ol type="1">
<li><p>transforming endDate</p></li>
<li><p>transforming startDate</p></li>
</ol>
<p>Otherwise we wouldn’t have gotten the correct result.</p>
</div>
</div>
</section>
<section id="solutions-for-special-forms-of-intervals" class="level2">
<h2 class="anchored" data-anchor-id="solutions-for-special-forms-of-intervals">Solutions for special forms of intervals</h2>
<p>The solution above works as long as you are dealing with real intervals <span class="math inline">\([a,b)\)</span> where <span class="math inline">\(a&lt;b\)</span> .</p>
<p>Sometimes, however, you can have the situation, that you have records that are only valid “a logical second”, meaning that you documented some changes in your records, but these changes didn’t lead to a real time span. In this case you have intervals where <span class="math inline">\(a=b\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dt_special <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">startDate =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2025-01-01"</span>,<span class="st">"2025-02-01"</span>,<span class="st">"2025-02-01"</span>)),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">endDate =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2025-02-01"</span>,<span class="st">"2025-02-01"</span>,<span class="st">"9999-12-31"</span>)),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Doe"</span>,<span class="st">"Smith"</span>,<span class="st">"Smith"</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">toPayPerMonth =</span> <span class="fu">c</span>(<span class="fl">1.23</span>,<span class="fl">1.23</span>,<span class="fl">2.34</span>))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>dt_special[,endDatem1 <span class="sc">:</span><span class="er">=</span> endDate <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>dt_special</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">toPayPerMonth</th>
<th style="text-align: left;">endDatem1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">Doe</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: left;">2025-01-31</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: left;">2025-01-31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">2.34</td>
<td style="text-align: left;">9999-12-30</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Lets see how foverlaps handles these situations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>result_sp1 <span class="ot">=</span> <span class="fu">foverlaps</span>(dt_special, intervals, <span class="at">by.x =</span> colsm1, <span class="at">by.y =</span> colsm1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in foverlaps(dt_special, intervals, by.x = colsm1, by.y = colsm1): All entries in column 'startDate' should be &lt;= corresponding entries in column 'endDatem1' in data.table x.</code></pre>
</div>
</div>
<p>As you can see the foverlaps-function returns an error-message.</p>
<section id="omit-these-rows-if-possible" class="level3">
<h3 class="anchored" data-anchor-id="omit-these-rows-if-possible">Omit these rows if possible</h3>
<p>In our use-case of this blog the easiest solution would be eliminate these rows from our dataset, as we are only interested in the amount someone has to pay which is time/date multiplied by the sum to pay per month. Lets see how we can do this</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>result_sp2 <span class="ot">=</span> <span class="fu">foverlaps</span>(dt_special[startDate <span class="sc">&lt;=</span> endDatem1], intervals, <span class="at">by.x =</span> colsm1, <span class="at">by.y =</span> colsm1)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>result_sp2[,.(startDate,endDate,name,toPayPerMonth)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">toPayPerMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">Doe</td>
<td style="text-align: right;">1.23</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">2.34</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">2.34</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>It works, but we loose the information, that the name-change didn’t cause a change of the payment per month.</p>
</section>
<section id="manipulate-the-start-columns-as-well" class="level3">
<h3 class="anchored" data-anchor-id="manipulate-the-start-columns-as-well">Manipulate the start columns as well</h3>
<p>If on the other hand we are interested in conserving the information that the name-change happened without change of payment per month, we will need a different approach</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dt_special[startDate <span class="sc">==</span> endDate, startDate <span class="sc">:</span><span class="er">=</span> startDate <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>result_sp3 <span class="ot">=</span> <span class="fu">foverlaps</span>(dt_special, intervals, <span class="at">by.x =</span> colsm1, <span class="at">by.y =</span> colsm1)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>result_sp3[i.startDate <span class="sc">==</span> endDatem1, startDate <span class="sc">:</span><span class="er">=</span> endDate]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>result_sp3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 6%">
<col style="width: 15%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">startDate</th>
<th style="text-align: left;">endDate</th>
<th style="text-align: left;">endDatem1</th>
<th style="text-align: left;">i.startDate</th>
<th style="text-align: left;">i.endDate</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">toPayPerMonth</th>
<th style="text-align: left;">i.endDatem1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-01-31</td>
<td style="text-align: left;">2025-01-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">Doe</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: left;">2025-01-31</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-01-31</td>
<td style="text-align: left;">2025-01-31</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: left;">2025-01-31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-02-28</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">2.34</td>
<td style="text-align: left;">9999-12-30</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-03-01</td>
<td style="text-align: left;">2025-04-01</td>
<td style="text-align: left;">2025-03-31</td>
<td style="text-align: left;">2025-02-01</td>
<td style="text-align: left;">9999-12-31</td>
<td style="text-align: left;">Smith</td>
<td style="text-align: right;">2.34</td>
<td style="text-align: left;">9999-12-30</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>What we did was:</p>
<ol type="1">
<li><p>subtract 1 day from startDate if it equals endDate</p></li>
<li><p>do our foverlaps procedure from above</p></li>
<li><p>set startDate to endDate if the original i.startDate (the one we changed) equals our manipulated endDatem1</p></li>
</ol>


</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>CC-BY-SA-4.0 (2025) Thomas Brand</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>