{
  "hash": "a86b31b8321195ac6a30fe0004de2435",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"filter functions for data.table\"\nauthor: \"Thomas Brand\"\ndate: \"2025-11-02\"\ncategories: [news, code, data.table, bquote]\ndraft: true\n---\n\n# Abstract\n\n# Motivation\n\nThe {data.table} package provides a very sophisticated way of filtering tables. Be ist just to extract all rows that fit a certain criteria or to manipulate/update data in the table for just the selected lines.\n\nLet's create some example data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\n\ndt = data.table(A = rep(LETTERS[1:3],times = 4),\n                B = rep(letters[4:9],times = 2),\n                C = seq(from = 0.02, by = 0.1, length.out = 12),\n                D = seq(from = as.Date(\"2025-10-01\"), by = \"day\", length.out = 12)\n)\ndt\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         A      B     C          D\n    <char> <char> <num>     <Date>\n 1:      A      d  0.02 2025-10-01\n 2:      B      e  0.12 2025-10-02\n 3:      C      f  0.22 2025-10-03\n 4:      A      g  0.32 2025-10-04\n 5:      B      h  0.42 2025-10-05\n 6:      C      i  0.52 2025-10-06\n 7:      A      d  0.62 2025-10-07\n 8:      B      e  0.72 2025-10-08\n 9:      C      f  0.82 2025-10-09\n10:      A      g  0.92 2025-10-10\n11:      B      h  1.02 2025-10-11\n12:      C      i  1.12 2025-10-12\n```\n\n\n:::\n:::\n\n\nand filter them in the ordinary way:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt[A == \"B\"]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        A      B     C          D\n   <char> <char> <num>     <Date>\n1:      B      e  0.12 2025-10-02\n2:      B      h  0.42 2025-10-05\n3:      B      e  0.72 2025-10-08\n4:      B      h  1.02 2025-10-11\n```\n\n\n:::\n:::\n\n\nLets define a filter-expression via bquote\n\n\n::: {.cell}\n\n```{.r .cell-code}\nf1 = bquote(A == \"B\") \ndt[eval(f1)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        A      B     C          D\n   <char> <char> <num>     <Date>\n1:      B      e  0.12 2025-10-02\n2:      B      h  0.42 2025-10-05\n3:      B      e  0.72 2025-10-08\n4:      B      h  1.02 2025-10-11\n```\n\n\n:::\n:::\n\n\nYou can also combine several filters via `.()`\\`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nf2 = bquote(D > as.Date(\"2025-10-06\"))\nf1and2 = bquote(.(f1) & .(f2))\ndt[eval(f1and2)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        A      B     C          D\n   <char> <char> <num>     <Date>\n1:      B      e  0.72 2025-10-08\n2:      B      h  1.02 2025-10-11\n```\n\n\n:::\n:::\n\n\nAnd in the same way you can update a data.table for just the rows that corresponds to the filter\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt2 = copy(dt)\ndt2[eval(f1and2), ':='(E = \"these rows were filterd\")]\ndt2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nIndex: <A>\n         A      B     C          D                       E\n    <char> <char> <num>     <Date>                  <char>\n 1:      A      d  0.02 2025-10-01                    <NA>\n 2:      B      e  0.12 2025-10-02                    <NA>\n 3:      C      f  0.22 2025-10-03                    <NA>\n 4:      A      g  0.32 2025-10-04                    <NA>\n 5:      B      h  0.42 2025-10-05                    <NA>\n 6:      C      i  0.52 2025-10-06                    <NA>\n 7:      A      d  0.62 2025-10-07                    <NA>\n 8:      B      e  0.72 2025-10-08 these rows were filterd\n 9:      C      f  0.82 2025-10-09                    <NA>\n10:      A      g  0.92 2025-10-10                    <NA>\n11:      B      h  1.02 2025-10-11 these rows were filterd\n12:      C      i  1.12 2025-10-12                    <NA>\n```\n\n\n:::\n:::\n\n\n::: callout-important\nThis works great, but is a lot of code to write, especially if you have work with the same filters on the same kind of data structure over and over again and probably want to combine one or several of them.\n:::\n\n# Solution\n\nLets construct a set of functions the will do the filtering\n\n-   a function that executes a filter\n\n-   a function that adds a filter with `&`\n\n-   a function that adds a filter with `|`\n\n-   a function that negates an existing filter\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# a simple function to execute the filter\nexecFilter = function(dt, f) {\n  dt[eval(f)]\n}\n\n# add another filter by \"and\"\nandFilter = function(f, andf) {\n  bquote(.(f) & .(andf))\n}\n\n# add another filter by \"or\"\norFilter = function(f, orf) {\n bquote(.(f) | .(orf)) \n}\n\n# negate filter\nnegFilter = function(f) {\n  bquote(!.(f))\n}\n```\n:::\n\n\n::: callout-note\nIn a real life scenario we would put in additional checks for the added filters.\n:::\n\nLet's see these functions in action. We want to construct a filter, that negates our `f1and2`\\` filter or where the value in column `C`\\` is either 0.32 or 0.42:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nCvalues = c(0.32, 0.42)\n# create a filter and \nf1 |> \n  andFilter(f2) |>\n  negFilter() |>\n  orFilter(bquote(C %in% .(Cvalues))) -> myFilter\n\nmyFilter\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n!(A == \"B\" & D > as.Date(\"2025-10-06\")) | C %in% c(0.32, 0.42\n)\n```\n\n\n:::\n:::\n\n\nWe can apply this filter\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexecFilter(dt, myFilter)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         A      B     C          D\n    <char> <char> <num>     <Date>\n 1:      A      d  0.02 2025-10-01\n 2:      B      e  0.12 2025-10-02\n 3:      C      f  0.22 2025-10-03\n 4:      A      g  0.32 2025-10-04\n 5:      B      h  0.42 2025-10-05\n 6:      C      i  0.52 2025-10-06\n 7:      A      d  0.62 2025-10-07\n 8:      C      f  0.82 2025-10-09\n 9:      A      g  0.92 2025-10-10\n10:      C      i  1.12 2025-10-12\n```\n\n\n:::\n:::\n\n\nFor convenience I would recommend to put these functions and filters in a Package. Additionally to the filters I would create special functions that execute my filters. e.g.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngetf1and2 = function(dt) {\n  dt[eval(f1and2)]\n}\n\ngetMyFilter = function(dt) {\n  dt[eval(myFilter)]\n}\n```\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}