{
  "hash": "689051958f4fd3c44bb0e16135375530",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Calculating months with fractions\"\nauthor: \"Thomas Brand\"\ndate: \"2025-06-09\"\ncategories: [news, code, lubridate, data.table, rowiseDT, interval, time_length]\ndraft: false\n---\n\n\n\n# Abstract\n\nIn this blog I will show you how you can calculate the number of months between two dates with the lubridate-package. This is quite an easy task, but you have to take into account certain special cases in which you might get a result, that is not quite what you would expect. I will also give you an solution of how you can avoid this problem.\n\n# Problem definition\n\nIn many cases you have the situation, that you bill a customer on a per month basis, e.g. in a subscription for a service. So any record (i.e. row) has a\n\n-   `startDate` which is the first day, that a row is valid and an\n\n-   `endDate` which is the first day, that a row isn't valid any more.\n\nWith this in mind you can easily calculate the months between two dates as the difference between the months of your dates if you subtract them.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(lubridate)\n\nstart = as.Date(\"2025-01-01\")\nend = as.Date(\"2025-03-01\")\n\nmonths_between = month(end) - month(start)\nmonths_between\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2\n```\n\n\n:::\n:::\n\n\n\nIn this case it doesn't matter how many days the month has, i.e. February with its 28 (29) days count as equally as one month as does March with its 31 days.\n\nApart for the obvious problems with year-changes in this calculation-approach, we will also have to deal with beginnings or endings within a month. This could be because someone started the subscription not on the first of a month or terminated the service before the end of the month, e.g. by right of premature cancellation or just because the person died.\n\nIn this cases you can't bill the customer for the whole month, just for the days he used the service. By definition we will assume that for $x$ days of service we can bill the customer with $\\frac{x}{dsom}$ of the monthly payment, with $dsom$ the number of days of the corresponding month.\n\nSo, let's look at several different situations of possible scenarios for calculating the **month-with-fractions**.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt = rowwiseDT(start=, end=, expected=, descr=,\n               \"2025-01-01\",\"2025-02-01\", 1.0,       \"1 month\",\n               \"2024-11-01\",\"2025-02-01\", 3.0,       \"3 months\",\n               \"2025-01-01\",\"2025-02-10\", 1 + 9/28,  \"1 month and 9 days of February\",\n               \"2025-01-15\",\"2025-02-01\", 17/31,     \"17 days\",\n               \"2025-02-01\",\"2025-03-10\", 1 + 9/31,  \"1 month an 9 days of March\",\n               \"2025-01-15\",\"2025-03-01\", 1 + 14/28, \"1 month and 14 days of February\",\n               \"2025-01-15\",\"2025-03-10\", 1 + 23/28, \"1 month and 14 + 9 = 25 days\",\n               \"2025-01-15\",\"2025-01-15\", 0,         \"0 months\",\n               \"2025-01-15\",\"2025-01-16\", 1/31,       \"0 months an 1 day of January\"\n               )\ndt\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        start        end   expected                           descr\n       <char>     <char>      <num>                          <char>\n1: 2025-01-01 2025-02-01 1.00000000                         1 month\n2: 2024-11-01 2025-02-01 3.00000000                        3 months\n3: 2025-01-01 2025-02-10 1.32142857  1 month and 9 days of February\n4: 2025-01-15 2025-02-01 0.54838710                         17 days\n5: 2025-02-01 2025-03-10 1.29032258      1 month an 9 days of March\n6: 2025-01-15 2025-03-01 1.50000000 1 month and 14 days of February\n7: 2025-01-15 2025-03-10 1.82142857    1 month and 14 + 9 = 25 days\n8: 2025-01-15 2025-01-15 0.00000000                        0 months\n9: 2025-01-15 2025-01-16 0.03225806    0 months an 1 day of January\n```\n\n\n:::\n:::\n\n\n\n::: callout-note\nTo construct the data.table we used the [rowiseDT](https://rdatatable.gitlab.io/data.table/reference/rowwiseDT.html)-function of data.table which was inspired by the [tribble](https://tibble.tidyverse.org/reference/tribble.html)-function of the [tibble](https://tibble.tidyverse.org/index.html)-package.\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/grafic-1.png){width=672}\n:::\n:::\n\n\n\n# Solution\n\nTo calculate the months we can use the following functions from the [lubridate](https://lubridate.tidyverse.org)-package\n\n-   [interval](https://lubridate.tidyverse.org/reference/interval.html) to define a date-interval and\n\n-   [time_length](https://lubridate.tidyverse.org/reference/time_length.html) to calculate the monts.\n\nLet's see how this works. First we build the intervals\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt[,interval := interval(start, end)]\ndt\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        start        end   expected                           descr\n       <char>     <char>      <num>                          <char>\n1: 2025-01-01 2025-02-01 1.00000000                         1 month\n2: 2024-11-01 2025-02-01 3.00000000                        3 months\n3: 2025-01-01 2025-02-10 1.32142857  1 month and 9 days of February\n4: 2025-01-15 2025-02-01 0.54838710                         17 days\n5: 2025-02-01 2025-03-10 1.29032258      1 month an 9 days of March\n6: 2025-01-15 2025-03-01 1.50000000 1 month and 14 days of February\n7: 2025-01-15 2025-03-10 1.82142857    1 month and 14 + 9 = 25 days\n8: 2025-01-15 2025-01-15 0.00000000                        0 months\n9: 2025-01-15 2025-01-16 0.03225806    0 months an 1 day of January\n                         interval\n                       <Interval>\n1: 2025-01-01 UTC--2025-02-01 UTC\n2: 2024-11-01 UTC--2025-02-01 UTC\n3: 2025-01-01 UTC--2025-02-10 UTC\n4: 2025-01-15 UTC--2025-02-01 UTC\n5: 2025-02-01 UTC--2025-03-10 UTC\n6: 2025-01-15 UTC--2025-03-01 UTC\n7: 2025-01-15 UTC--2025-03-10 UTC\n8: 2025-01-15 UTC--2025-01-15 UTC\n9: 2025-01-15 UTC--2025-01-16 UTC\n```\n\n\n:::\n:::\n\n\n\n::: callout-note\nAs you can see, we didn't even have to convert the character-dates into actual dates. The interval-function did all this for us.\n:::\n\nThen we calculate the months\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndt[,months := time_length(interval,\n                          unit = \"month\")]\ndt\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        start        end   expected                           descr\n       <char>     <char>      <num>                          <char>\n1: 2025-01-01 2025-02-01 1.00000000                         1 month\n2: 2024-11-01 2025-02-01 3.00000000                        3 months\n3: 2025-01-01 2025-02-10 1.32142857  1 month and 9 days of February\n4: 2025-01-15 2025-02-01 0.54838710                         17 days\n5: 2025-02-01 2025-03-10 1.29032258      1 month an 9 days of March\n6: 2025-01-15 2025-03-01 1.50000000 1 month and 14 days of February\n7: 2025-01-15 2025-03-10 1.82142857    1 month and 14 + 9 = 25 days\n8: 2025-01-15 2025-01-15 0.00000000                        0 months\n9: 2025-01-15 2025-01-16 0.03225806    0 months an 1 day of January\n                         interval     months\n                       <Interval>      <num>\n1: 2025-01-01 UTC--2025-02-01 UTC 1.00000000\n2: 2024-11-01 UTC--2025-02-01 UTC 3.00000000\n3: 2025-01-01 UTC--2025-02-10 UTC 1.32142857\n4: 2025-01-15 UTC--2025-02-01 UTC 0.54838710\n5: 2025-02-01 UTC--2025-03-10 UTC 1.29032258\n6: 2025-01-15 UTC--2025-03-01 UTC 1.50000000\n7: 2025-01-15 UTC--2025-03-10 UTC 1.82142857\n8: 2025-01-15 UTC--2025-01-15 UTC 0.00000000\n9: 2025-01-15 UTC--2025-01-16 UTC 0.03225806\n```\n\n\n:::\n:::\n\n\n\nAs you can see the calculated months for the interval 2025-01-15 to 2025-03-10 (row number 7) are kind of strange in the sense, that the function calculates\n\n-   one month from 2025-01-15 to 2025-02-15\n\n-   23 days between 2025-02-15 and 2025-03-10 (which is the correct number of days, by the way); these 23 days will be divided by 28 as the 15th is in the month of February. That will give you 0.8214286\n\nThis may not be what you like.\n\nIf you expected (as I did), that the interval 2025-01-15 to 2025-03-10 will give you\n\n-   17/31 for the 17 days of January\n\n-   1 for the month of February\n\n-   9/31 for the 9 days of March\n\ngiving 1.8387097 you will have to make sure, that an interval, that doesn't start at the first of a month, will be split into two rows\n\n-   so that the end of the first row will be the first of the month following the start (see row 4) and\n\n-   the second row will start with the first of the month following the original start-date (see row 5).\n\nIn sum these two rows will give you the expected result.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}